<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex,nofollow">
<title>GMã‚·ãƒ¼ãƒ«æŠ½é¸ä¼š</title>

<style>
body {
  background: #fff8e7;
  text-align: center;
  font-family: "Hiragino Maru Gothic ProN", sans-serif;
}

h1 {
  color: #ff6b6b;
  margin-top: 20px;
}

#slot {
  margin: 30px auto;
  width: 260px;
  height: 260px;
  border: 10px solid #ffcc66;
  border-radius: 30px;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

#slot img {
  width: 220px;
  height: 220px;
}

button {
  font-size: 24px;
  padding: 15px 40px;
  border-radius: 20px;
  border: none;
  background: #4caf50;
  color: white;
}

button:disabled {
  background: #aaa;
}

#result {
  margin-top: 25px;
  font-size: 22px;
}
</style>
</head>

<body>

<h1>GMã‚·ãƒ¼ãƒ«æŠ½é¸ä¼š</h1>

<div id="slot">
  <img id="slotImage" src="https://raw.githubusercontent.com/work-sakumi/gm-slot/bcc055a9fca233e9970d7b3436db7a4c856ee167/gm-slot/images/sticker01.png" alt="slot image">
</div>

<button id="enableBtn">ğŸ”Š éŸ³ã‚’å‡ºã—ã¦ã¯ã˜ã‚ã‚‹</button>
<br><br>
<button id="startBtn" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<div id="result"></div>

<script>
/* ====== ãƒ™ãƒ¼ã‚¹ï¼ˆå›ºå®šã® raw URL ã‚’ä½¿ã„ã€æ—¢å­˜ã® gm-slot ãƒ•ã‚©ãƒ«ãƒ€å†…ã®è³‡ç”£ã‚’å‚ç…§ã—ã¾ã™ï¼‰ */
const baseRaw = 'https://raw.githubusercontent.com/work-sakumi/gm-slot/bcc055a9fca233e9970d7b3436db7a4c856ee167/gm-slot';

/* ====== ã‚·ãƒ¼ãƒ« ====== */
const stickers = [];
for (let i = 1; i <= 40; i++) {
  stickers.push(`${baseRaw}/images/sticker${String(i).padStart(2,"0")}.png`);
}

/* ãƒ—ãƒ¬ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã®æ—©æœŸç¢ºèªã«ã‚‚ãªã‚‹ï¼‰ */
const preloaded = [];
stickers.forEach(src => {
  const img = new Image();
  img.src = src;
  img.onload = () => console.log('image loaded:', src);
  img.onerror = () => console.warn('image NOT found:', src);
  preloaded.push(img);
});

/* ====== åŠ¹æœéŸ³ï¼ˆæ—¢å­˜ã® sounds ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ raw ã‹ã‚‰å‚ç…§ï¼‰ */
const startSound = new Audio(`${baseRaw}/sounds/start.mp3`);
const spinSound  = new Audio(`${baseRaw}/sounds/spin.mp3`);
spinSound.loop = true;
const fanfareSound = new Audio(`${baseRaw}/sounds/fanfare.mp3`);

/* ====== ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–‡ç« ï¼ˆã“ã“ã«ç›´æ¥æ›¸ãï¼‰ ====== */
const narrationStartText = `
ï¼‘å¹´é–“ã€GMãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é ‘å¼µã‚Šã¾ã—ãŸã­ã€‚
ã“ã‚Œã‹ã‚‰ã€GMã‚·ãƒ¼ãƒ«æŠ½é¸ä¼šã‚’å§‹ã‚ã¾ã™ã€‚
ã‚¹ãƒ­ãƒƒãƒˆãŒå›ã‚Šã€æ­¢ã¾ã£ãŸã‚·ãƒ¼ãƒ«ãŒã€
ã‚ãªãŸã®ã‚¯ãƒ©ã‚¹ã®ã€ã‚ãŸã‚Šã‚·ãƒ¼ãƒ«ã§ã™ã€‚
ãã‚Œã§ã¯ã€ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚
`;

const narrationEndText = `
ã¿ãªã•ã‚“ã€è‡ªåˆ†ã®GMã‚«ãƒ¼ãƒ‰ã«ã€
ã‚ãŸã‚Šã‚·ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã—ãŸã‹ã€‚
ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ã‚ãŸã‚Šã‚·ãƒ¼ãƒ«ãŒã‚ã£ãŸäººã¯ã€
ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚
æ¥æœˆã€æ™¯å“ã‚’ãŠæ¸¡ã—ã—ã¾ã™ã€‚

ã‚·ãƒ¼ãƒ«ãŒãªã‹ã£ãŸäººã‚‚ã€
è¦‹é€ƒã—ã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹ã®ã§ã€
å…ˆç”Ÿã«GMã‚«ãƒ¼ãƒ‰ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚

æ¥å¹´ã‚‚ã€GMãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã€
å…ƒæ°—ã«ç”Ÿæ´»ã—ã¾ã—ã‚‡ã†ã€‚
ã“ã‚Œã§ã€GMã‚·ãƒ¼ãƒ«æŠ½é¸ä¼šã‚’çµ‚ã‚ã‚Šã¾ã™ã€‚
`;

/* ====== AIéŸ³å£°èª­ã¿ä¸Šã’ ====== */
function speak(text) {
  try {
    const uttr = new SpeechSynthesisUtterance(text);
    uttr.lang = "ja-JP";
    uttr.rate = 0.8;   // ã‚†ã£ãã‚Š
    uttr.pitch = 1.0;
    speechSynthesis.speak(uttr);
  } catch (e) {
    console.warn('speech failed:', e);
  }
}

/* ====== UI è¦ç´  ====== */
const enableBtn = document.getElementById('enableBtn');
const startBtn = document.getElementById('startBtn');
const slotImage = document.getElementById('slotImage');
const resultDiv = document.getElementById('result');

enableBtn.addEventListener('click', () => {
  // å¸¸ã« start ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ï¼ˆSpeech API ãŒä½¿ãˆãªã„ç’°å¢ƒã§ã‚‚é€²ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
  startBtn.disabled = false;
  enableBtn.style.display = 'none';

  // è©±ã™è©¦ã¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œãªã®ã§å¤šãã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è¨±å¯ã•ã‚Œã‚‹ï¼‰
  try {
    speak(narrationStartText);
  } catch (e) {
    console.warn('speak error:', e);
  }

  // (ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®äº‹å‰å†ç”Ÿã§ unlock ã‚’è©¦ã¿ã‚‹: ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–)
  startSound.play().catch(e => console.info('startSound play blocked (ignored):', e));
  spinSound.play().then(() => { spinSound.pause(); spinSound.currentTime = 0; }).catch(()=>{});
  fanfareSound.play().then(() => { fanfareSound.pause(); fanfareSound.currentTime = 0; }).catch(()=>{});
});

let timer = null;

/* ====== ã‚¹ãƒ­ãƒƒãƒˆé–‹å§‹ ====== */
function startSlot() {
  console.log('startSlot called');
  startBtn.disabled = true;
  resultDiv.innerHTML = "";

  // éŸ³ã®å†ç”Ÿã¯ Promise ã‚’ catch ã—ã¦ä¾‹å¤–ã§æ­¢ã‚ãªã„
  startSound.currentTime = 0;
  startSound.play().catch(e => console.warn('startSound.play() rejected:', e));

  spinSound.currentTime = 0;
  spinSound.play().catch(e => console.warn('spinSound.play() rejected:', e));

  timer = setInterval(() => {
    const r = Math.floor(Math.random() * stickers.length);
    slotImage.src = stickers[r];
  }, 80);

  setTimeout(stopSlot, 3000);
}

/* ====== åœæ­¢ ====== */
function stopSlot() {
  console.log('stopSlot called');
  if (timer) {
    clearInterval(timer);
    timer = null;
  }
  // åœæ­¢éŸ³
  try {
    spinSound.pause();
  } catch (e) { console.warn(e); }

  fanfareSound.currentTime = 0;
  fanfareSound.play().catch(e => console.warn('fanfare play rejected:', e));

  const img = slotImage.src;
  resultDiv.innerHTML =
    "ã‚ãªãŸã®ã‚¯ãƒ©ã‚¹ã®ã‚ãŸã‚Šã‚·ãƒ¼ãƒ«ã¯ã€<br>" +
    "<img src='" + img + "' style='width:160px;margin-top:10px;'>";

  setTimeout(() => {
    speak(narrationEndText);
    // ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
    startBtn.disabled = false;
  }, 1500);
}

/* ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ onclick ã‚’é™¤å»ï¼‰ */
startBtn.addEventListener('click', startSlot);
</script>

</body>
</html>
